<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Withdrawal History</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="history_style.css">
</head>
<body>
    <div class="app-container">
        <div class="header">
            <button class="back-btn" onclick="window.location.href='main.html'"><i class="fas fa-arrow-left"></i></button>
            <h1>Withdrawal History</h1>
        </div>
        
        <div class="history-content" id="history-content">
            <p id="loading-message">Loading history...</p>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script>
        // Your Firebase config
        const firebaseConfig = {
            apiKey: "AIzaSyDmJ8wsK6sYlRX2DWYTFmxwZONCL9nsmos",
            authDomain: "ensen-mining-bd-4882b.firebaseapp.com",
            databaseURL: "https://ensen-mining-bd-4882b-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ensen-mining-bd-4882b",
            storageBucket: "ensen-mining-bd-4882b.firebasestorage.app",
            messagingSenderId: "1006758844776",
            appId: "1:1006758844776:web:df590613a79e1e9eed1edd",
            measurementId: "G-8YKDVM1W8B"
        };
    
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();
    
        document.addEventListener('DOMContentLoaded', () => {
            const historyContentEl = document.getElementById('history-content');
            const loadingMessageEl = document.getElementById('loading-message');
    
            auth.onAuthStateChanged(user => {
                if (user) {
                    const userId = user.uid;
                    const historyRef = db.ref('users/' + userId + '/withdrawals');
    
                    historyRef.on('value', (snapshot) => {
                        const historyData = snapshot.val();
                        historyContentEl.innerHTML = ''; // Clear previous content
                        loadingMessageEl.style.display = 'none'; // Hide loading message
    
                        if (historyData) {
                            const sortedHistory = Object.values(historyData).sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
                            sortedHistory.forEach(item => {
                                const historyItem = document.createElement('div');
                                historyItem.className = 'history-item';
                                historyItem.innerHTML = `
                                    <div class="history-icon ${item.status === 'Completed' ? 'completed' : 'pending'}">
                                        <i class="fas ${item.status === 'Completed' ? 'fa-check-circle' : 'fa-hourglass-half'}"></i>
                                    </div>
                                    <div class="history-details">
                                        <p class="history-title">Withdrawal Request</p>
                                        <p class="history-date">${new Date(item.timestamp).toLocaleString()}</p>
                                        <p class="history-method">Method: ${item.method}</p>
                                        <p class="history-status">Status: ${item.status}</p>
                                    </div>
                                    <div class="history-amount">à§³${item.amount}</div>
                                `;
                                historyContentEl.appendChild(historyItem);
                            });
                        } else {
                            historyContentEl.innerHTML = '<div class="no-history-message">No withdrawal history found.</div>';
                        }
                    }, (error) => {
                        console.error("Error loading history: ", error);
                        historyContentEl.innerHTML = '<div class="error-message">Failed to load history. Please try again later.</div>';
                    });
    
                } else {
                    window.location.href = 'index.html'; // Redirect to login if not authenticated
                }
            });
        });
    </script>
</body>
</html>
