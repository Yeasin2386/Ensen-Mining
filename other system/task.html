<!DOCTYPE html>
<html lang="bn">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#F8F5EF" />
  <title>Grand — Task</title>

  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet" />

  <link rel="stylesheet" href="../style.css" /> 
  <style>
    /* এখানে শুধু task.html এর জন্য যদি কোনো নতুন CSS লাগে, তা যুক্ত করা হবে।
    আপনার মূল ডিজাইন style.css থেকে আসবে।
    */
    .task-limit-card {
        background: var(--accent-primary);
        color: var(--text-primary);
        padding: 20px;
        border-radius: var(--radius-lg);
        text-align: center;
        margin-top: 10px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
    }
    .task-limit-card .balance-label {
        font-weight: 600;
        color: var(--text-primary);
        opacity: 0.8;
        font-size: 1rem;
        margin-bottom: 5px;
    }
    .task-limit-card .balance-amount {
        font-size: 2.2rem;
        font-weight: 800;
        font-family: var(--font-heading);
    }
    
    /* Navigation Active State */
    .bottom-nav a[href="task.html"] {
        color: var(--accent-primary) !important;
    }
  </style>
</head>
<body>
  
  <div id="preloader" class="preloader">
    <div class="preloader-content">
      <h1 class="preloader-brand">Grand</h1>
      <div class="preloader-progress"><div class="preloader-progress-bar"></div></div>
      <p class="preloader-powered">powered by Yeasin Group</p>
    </div>
  </div>

  <div id="app" class="app" aria-hidden="true">
    
    <header class="app-header">
      <a href="../index.html" class="header-logo" aria-label="হোমপেজ">
        <img src="../image/Gemini_Generated_Image_dcsl0idcsl0idcsl.png" alt="Grand Logo" />
      </a>
      <h3 class="page-title">All Tasks</h3>
      <a href="../index.html" class="header-action-btn">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.149-.439 1.588 0L21.75 12M4.5 9.75v10.125a3 3 0 003 3h8.25a3 3 0 003-3V9.75M8.25 21.75h7.5" /></svg>
      </a>
    </header>
    
    <main class="app-content">
      
      <section class="task-limit-section">
        <div class="task-limit-card">
          <h4 class="balance-label">Total Tasks Today</h4>
          <h2 class="balance-amount" id="tasks-today-page">0/20</h2>
        </div>
      </section>

      <section class="tasks-list-section mt-4">

        <h3 class="section-title">Video Tasks (Daily)</h3>
        
        <div class="task-card" data-task-id="watch-video" data-reward="1.00">
          <div class="task-info">
            <div class="task-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15.91 11.672a.375.375 0 010 .656l-5.603 3.113a.375.375 0 01-.557-.328V8.887c0-.286.307-.466.557-.328l5.603 3.113z" /></svg>
            </div>
            <div class="task-details">
              <h4 class="task-title">Watch Video Ad</h4>
              <p class="task-reward">Reward: ৳1.00 (Repeatable)</p>
            </div>
          </div>
          <button class="btn-go" data-open-modal="watch-video">Go</button>
        </div>
        
        <h3 class="section-title mt-4">One-Time Tasks</h3>
        
        <div class="task-card" data-task-id="join-channel" data-reward="5.00">
          <div class="task-info">
            <div class="task-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 6.75h18a2.25 2.25 0 002.25-2.25v-8.25a2.25 2.25 0 00-2.25-2.25h-18A2.25 2.25 0 003 6.75v8.25a2.25 2.25 0 002.25 2.25z" /></svg>
            </div>
            <div class="task-details">
              <h4 class="task-title">Join Telegram Channel</h4>
              <p class="task-reward">Reward: ৳5.00 (One time)</p>
            </div>
          </div>
          <a href="https://t.me/your_channel_link" target="_blank" class="btn-go">Go</a>
        </div>
        
      </section>

    </main>
    
    <nav class="bottom-nav">
      <a href="../index.html" class="nav-item">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.149-.439 1.588 0L21.75 12M4.5 9.75v10.125a3 3 0 003 3h8.25a3 3 0 003-3V9.75M8.25 21.75h7.5" /></svg>
        <span>Home</span>
      </a>
      <a href="task.html" class="nav-item active">
        <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        <span>Task</span>
      </a>
      <a href="withdraw.html" class="nav-item">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
        <span>Withdraw</span>
      </a>
      <a href="tutorial.html" class="nav-item">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 10.5l-6 6m0 0l-6-6m6 6V3" /></svg>
        <span>Tutorial</span>
      </a>
      <a href="referral.html" class="nav-item">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 6.75h18a2.25 2.25 0 002.25-2.25v-8.25a2.25 2.25 0 00-2.25-2.25h-18A2.25 2.25 0 003 6.75v8.25a2.25 2.25 0 002.25 2.25z" /></svg>
        <span>Referral</span>
      </a>
    </nav>
    
    <div id="modal-watch-video" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
        <div class="modal-backdrop" data-close-modal></div>
        <div class="modal-dialog">
            <div class="modal-icon-wrapper">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15.91 11.672a.375.375 0 010 .656l-5.603 3.113a.375.375 0 01-.557-.328V8.887c0-.286.307-.466.557-.328l5.603 3.113z" /></svg>
            </div>
            <div class="modal-header">
                <h3>দৈনিক ভিডিও টাস্ক</h3>
                <span class="modal-reward">পুরষ্কার: ৳1.00</span>
            </div>
            <div class="modal-body">
                <p>পুরষ্কার পেতে হলে আপনাকে ভিডিও বিজ্ঞাপনটি সম্পূর্ণ দেখতে হবে। ভিডিও শেষ হওয়ার পর "Complete" বাটনটি সক্রিয় হবে।</p>
            </div>
            <div class="modal-actions">
                <button class="btn-primary" data-action="start-video">Watch Now</button>
                <button class="btn-secondary" data-action="confirm-task" data-task="watch-video" disabled>Complete</button>
            </div>
        </div>
    </div>


  <script src='//libtl.com/sdk.js' data-zone='10002890' data-sdk='show_10002890'></script>
  <script>
    const $ = (selector, parent = document) => parent.querySelector(selector);
    const $$ = (selector, parent = document) => Array.from(parent.querySelectorAll(selector));

    // CRITICAL CHANGE: The daily limit is now a single, shared value (20)
    const STORE_KEYS = { balance: "grand_balance_v3", tasks: "grand_tasks_v3" };
    const DAILY_TASK_LIMIT = 20;

    const store = {
      get: (key, fallback = null) => {
        try {
          const value = localStorage.getItem(key);
          return value ? JSON.parse(value) : fallback;
        } catch (e) {
          return fallback;
        }
      },
      set: (key, value) => {
        try {
          localStorage.setItem(key, JSON.stringify(value));
        } catch (e) {
          console.error("Failed to save to localStorage", e);
        }
      },
    };

    let balance = store.get(STORE_KEYS.balance, 0);
    let tasksState = store.get(STORE_KEYS.tasks, {});
    let videoTimer = null;
    
    const tasksFromDOM = $$(".task-card").map(card => ({
        id: card.dataset.taskId,
        reward: Number(card.dataset.reward || 0),
        duration: card.dataset.duration ? Number(card.dataset.duration) : null,
        goButton: card.querySelector(".btn-go"),
    }));

    // --- Core Functions (Task Page Specific) ---

    function isToday(ts) {
        if (!ts) return false;
        const today = new Date();
        const otherDate = new Date(ts);
        return today.getFullYear() === otherDate.getFullYear() &&
               today.getMonth() === otherDate.getMonth() &&
               today.getDate() === otherDate.getDate();
    };

    /**
     * **UPDATED:** Checks the count of completed video tasks for today.
     * Resets the count if a new day has started (daily reset logic).
     */
    function getCompletedTasksToday() {
        const videoTaskState = tasksState['watch-video'] || {};
        
        // Check if the last completion time is NOT today
        if (!videoTaskState.completed_at || !isToday(videoTaskState.completed_at)) {
            // Reset the count for the new day
            tasksState['watch-video'] = { status: "pending", completed_at: null, count: 0 };
            return 0; 
        }
        
        // Return the current count (default to 0 if count property is missing)
        return videoTaskState.count || 0;
    }

    /**
     * FIX APPLIED: Made syncTasksAndStats more robust for multi-completion tasks.
     */
    function syncTasksAndStats() {
      let todayCompletedCount = getCompletedTasksToday();
      
      tasksFromDOM.forEach(task => {
        if (!tasksState[task.id]) {
          tasksState[task.id] = { status: "pending", completed_at: null };
        }
        
        // Task Page Logic: Only check total limit (no restriction on the first task)
        if (task.id === 'watch-video') {
            if (todayCompletedCount >= DAILY_TASK_LIMIT) {
                task.goButton.textContent = "Limit End";
                task.goButton.disabled = true;
            } else {
                task.goButton.textContent = "Go";
                task.goButton.disabled = false;
            }
        }
        
        // Handle one-time tasks (e.g., join-channel)
        if (task.id === 'join-channel') {
            const taskState = tasksState[task.id] || { status: "pending" };
            if (taskState.status === 'completed') {
                task.goButton.textContent = "Done";
                task.goButton.disabled = true;
                task.goButton.href = "#";
            }
        }
      });
      store.set(STORE_KEYS.tasks, tasksState);
      updateTaskLimitUI(todayCompletedCount);
    }

    function updateTaskLimitUI(todayCount) {
      const taskLimitEl = $("#tasks-today-page");
      if (taskLimitEl) taskLimitEl.textContent = `${todayCount}/${DAILY_TASK_LIMIT}`;
    }

    /**
     * **UPDATED:** Completion logic with strict limits and professional messages.
     */
    function completeTask(taskId) {
      const taskDef = tasksFromDOM.find(t => t.id === taskId);
      let todayCompletedCount = getCompletedTasksToday();
      const videoTaskState = tasksState['watch-video'] = tasksState['watch-video'] || { status: "pending", completed_at: null, count: 0 };


      if (!taskDef) return;
      
      // Strict Limits Check
      if (taskId === 'watch-video') {
          // --- 1. TOTAL LIMIT CHECK (Shared for all pages) ---
          if (todayCompletedCount >= DAILY_TASK_LIMIT) {
              // Professional message for total limit end
              alert(`দুঃখিত! আজকের (${DAILY_TASK_LIMIT}টি) ভিডিও টাস্কের লিমিট শেষ হয়েছে। নতুন টাস্কের জন্য অপেক্ষা করুন।`);
              return;
          }
          
          // --- AD COMPLETION CHECK (CRITICAL) ---
          const modal = $(`#modal-watch-video`);
          const startBtn = modal.querySelector('[data-action="start-video"]');
          if (startBtn.textContent !== 'Finished') {
             alert('ভিডিওটি সম্পূর্ণ দেখা হয়নি বা বিজ্ঞাপন লোড হচ্ছে। "Watch Now" বাটনে ক্লিক করে বিজ্ঞাপনটি শেষ করুন।');
             return;
          }
      } else if (taskId === 'join-channel') {
           const taskState = tasksState[taskId] || {};
           if (taskState.status === 'completed') {
              alert('এই টাস্কটি একবারই সম্পন্ন করা যায়, যা আপনি ইতিমধ্যেই করে ফেলেছেন।');
              return;
           }
      }

      // Completion Logic
      if (taskId === 'watch-video') {
          videoTaskState.count = todayCompletedCount + 1; // Increment the shared count
          videoTaskState.completed_at = Date.now(); // Update timestamp for daily reset
          videoTaskState.status = (videoTaskState.count >= DAILY_TASK_LIMIT) ? "completed" : "pending";
      } else if (taskId === 'join-channel') {
          tasksState[taskId] = { status: "completed", completed_at: Date.now() };
      }
      
      // Update balance
      balance += taskDef.reward;
      
      // Save state
      store.set(STORE_KEYS.tasks, tasksState);
      store.set(STORE_KEYS.balance, balance);

      // Close modal after successful completion.
      closeModal($(`#modal-${taskId}`));
      syncTasksAndStats();
    }

    // --- Modal Logic (Professional Messages) ---
    
    function openModal(modalId) {
      const modal = $(`#modal-${modalId}`);
      if (!modal) return;
      modal.setAttribute("aria-hidden", "false");
      document.body.style.overflow = "hidden";

      if (modalId === "watch-video") {
        const completeBtn = modal.querySelector('[data-action="confirm-task"]');
        const startBtn = modal.querySelector('[data-action="start-video"]');
        completeBtn.disabled = true;
        startBtn.disabled = false;
        startBtn.textContent = "Watch Now";
      }
    }

    function closeModal(modal) {
      if (!modal) return;
      modal.setAttribute("aria-hidden", "true");
      document.body.style.overflow = "";
      if (videoTimer) {
        clearInterval(videoTimer);
        videoTimer = null;
      }
    }

    function startMonetagAd(startBtn) {
        if (typeof show_10002890 !== 'function') {
            alert("বিজ্ঞাপন লোড হচ্ছে, কিছুক্ষণ অপেক্ষা করুন বা পেজ রিফ্রেশ করুন।");
            startBtn.disabled = false;
            startBtn.textContent = 'Watch Now';
            return;
        }

        startBtn.disabled = true;
        startBtn.textContent = 'Ad Loading...';

        show_10002890().then(() => {
            startBtn.textContent = "Finished";
            const modal = startBtn.closest(".modal");
            const completeBtn = modal.querySelector('[data-action="confirm-task"]');
            completeBtn.disabled = false;
            // Professional, Monetag-free success message
            alert('ভিডিওটি সফলভাবে দেখা হয়েছে! টাস্কটি সম্পূর্ণ করতে এখন "Complete" বাটনে ক্লিক করুন।');
        }).catch((error) => {
            startBtn.disabled = false;
            startBtn.textContent = 'Watch Now';
            console.error('Monetag Ad Error:', error);
            // Professional, Monetag-free error message
            alert('ভিডিওটি লোড করা সম্ভব হয়নি। অনুগ্রহ করে আবার চেষ্টা করুন।');
        });
    }
    
    function bindEvents() {
      document.addEventListener("click", (e) => {
        const openModalBtn = e.target.closest("[data-open-modal]");
        if (openModalBtn) openModal(openModalBtn.dataset.openModal);
        
        const closeModalBtn = e.target.closest("[data-close-modal]");
        if (closeModalBtn) closeModal(closeModalBtn.closest(".modal"));
        
        const confirmBtn = e.target.closest('[data-action="confirm-task"]');
        if (confirmBtn && !confirmBtn.disabled) {
          completeTask(confirmBtn.dataset.task);
        }

        const startVideoBtn = e.target.closest('[data-action="start-video"]');
        if (startVideoBtn && !startVideoBtn.disabled) startMonetagAd(startVideoBtn);
      });
    }
    
    function init() {
      $("#preloader").classList.add("hidden");
      $("#app").setAttribute("aria-hidden", "false");
      syncTasksAndStats();
      bindEvents();
    }
    
    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
